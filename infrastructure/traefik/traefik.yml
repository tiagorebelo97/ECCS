# ============================================================================
# Traefik Static Configuration - ECCS Platform
# ============================================================================
# Main Traefik configuration file for API gateway functionality.
# This file is read once at startup. Use dynamic configuration for
# changes that should take effect without restart.
#
# CONFIGURATION HIERARCHY:
#   1. CLI flags (highest priority)
#   2. Environment variables
#   3. This static configuration file
#   4. Dynamic configuration files (lowest priority)
#
# SECURITY OVERVIEW:
#   - API Gateway enforces authentication, rate limiting, and TLS
#   - JWT tokens validated via ForwardAuth to auth-service
#   - Rate limiting prevents DDoS and brute force attacks
#   - TLS 1.2+ enforced with strong cipher suites
#   - Container discovery via Podman socket (read-only access)
#
# PODMAN COMPATIBILITY:
#   This configuration supports both Docker and Podman runtimes.
#   Set CONTAINER_SOCK environment variable to the appropriate socket path:
#   - Docker: /var/run/docker.sock
#   - Podman (rootless): /run/user/1000/podman/podman.sock
#   - Podman (rootful): /run/podman/podman.sock
# ============================================================================

# -----------------------------------------------------------------------------
# Global Settings
# -----------------------------------------------------------------------------
global:
  # Don't check for Traefik updates (security: prevents external requests)
  checkNewVersion: false
  # Don't send anonymous usage data (privacy)
  sendAnonymousUsage: false

# -----------------------------------------------------------------------------
# API and Dashboard
# -----------------------------------------------------------------------------
# SECURITY: Dashboard exposed on internal port only (8080)
# In production, consider disabling insecure mode and using authentication
api:
  # Enable the API (required for dashboard)
  insecure: true  # PRODUCTION: Set to false and use proper authentication
  # Enable the dashboard for monitoring and debugging
  dashboard: true
  # Debug mode (disable in production for security)
  debug: false

# Enable ping endpoint for health checks
# ROUTING: Exposed on the traefik entrypoint (port 8080)
ping:
  entryPoint: traefik

# -----------------------------------------------------------------------------
# Entrypoints
# -----------------------------------------------------------------------------
# Entrypoints are the network entry points into Traefik.
# Each entrypoint listens on a specific port and protocol.
#
# PODMAN COMPATIBILITY:
#   Ports 8800 and 8443 are used instead of 80 and 443 for rootless
#   Podman compatibility. Privileged ports (< 1024) require root access.
#   Port 8800 is used instead of 8000 to avoid conflicts with commonly used ports.
#
# SECURITY ARCHITECTURE:
#   - web (8800): HTTP traffic, can redirect to HTTPS
#   - websecure (8443): HTTPS traffic with TLS termination
#   - traefik (8080): Internal dashboard and metrics (restrict in production)
entryPoints:
  # HTTP entrypoint (port 8800)
  # ROUTING: Handles unencrypted HTTP traffic
  # SECURITY: In production, redirect all HTTP to HTTPS
  web:
    address: ":8800"
    # HTTP to HTTPS redirection (uncomment in production)
    # SECURITY: Forces all traffic through encrypted channel
    # http:
    #   redirections:
    #     entryPoint:
    #       to: websecure
    #       scheme: https
    #       permanent: true

  # HTTPS entrypoint (port 8443)
  # ROUTING: Handles encrypted HTTPS traffic with TLS termination
  # SECURITY: TLS configuration defined in dynamic config
  websecure:
    address: ":8443"
    # HTTP/2 settings for improved performance
    http2:
      maxConcurrentStreams: 250
    # HTTP/3 QUIC support (optional, requires UDP)
    # http3: {}
    # Default TLS options (references tls.options.default in dynamic config)

  # Dashboard/API entrypoint (internal only)
  # SECURITY: Bind to localhost only in production
  # address: "127.0.0.1:8080"
  traefik:
    address: ":8080"

# -----------------------------------------------------------------------------
# Providers - Dynamic Service Discovery
# -----------------------------------------------------------------------------
# Providers are infrastructure components that provide configuration to Traefik.
# Traefik supports multiple providers simultaneously for flexible deployment.
#
# NOTE: Docker provider is disabled to avoid permission issues with Podman.
# All service routing is defined via the file provider in dynamic-config.yml.
# This ensures Traefik works reliably regardless of container runtime.
#
# CONTAINER LABEL FORMAT (for reference, not used when Docker provider is disabled):
#   - traefik.enable=true                          # Enable container routing
#   - traefik.http.routers.<name>.rule=...         # Routing rule
#   - traefik.http.services.<name>.loadbalancer... # Service config
providers:
  # -------------------------------------------------------------------------
  # Docker/Podman Provider - DISABLED
  # -------------------------------------------------------------------------
  # Docker provider is disabled to avoid permission issues when using Podman.
  # The container socket may not be accessible or may require specific
  # permissions that are not available in rootless Podman environments.
  #
  # If you need dynamic service discovery with Podman, configure the
  # CONTAINER_SOCK environment variable to point to the Podman socket
  # and ensure proper permissions are set. Then enable the provider below.
  # docker:
  #   endpoint: "unix:///var/run/docker.sock"
  #   exposedByDefault: false
  #   network: eccs-network
  #   watch: true
  #   defaultRule: "Host(`{{ normalize .Name }}.localhost`)"

  # -------------------------------------------------------------------------
  # File Provider - Static and Override Configuration
  # -------------------------------------------------------------------------
  # CONFIGURATION: Loads additional configuration from YAML/TOML files.
  # Used for middlewares, TLS options, and static service definitions.
  #
  # USAGE:
  #   - Define reusable middlewares (rate limiting, auth, headers)
  #   - Configure TLS certificates and options
  #   - Define all service routing (since Docker provider is disabled)
  file:
    # Specific dynamic configuration file to load
    # Contains all service definitions, routers, and middlewares
    filename: "/etc/traefik/dynamic/dynamic-config.yml"
    # Watch for file changes (enables hot-reload)
    # DYNAMIC UPDATES: Configuration changes apply without restart
    watch: true

# -----------------------------------------------------------------------------
# Logging
# -----------------------------------------------------------------------------
# OBSERVABILITY: Structured logging for debugging and monitoring.
# JSON format enables easy parsing by log aggregation systems (ELK, Loki).
log:
  # Log level (DEBUG, INFO, WARN, ERROR)
  # PRODUCTION: Use INFO or WARN to reduce log volume
  level: INFO
  # Log format (common, json)
  # JSON format for structured logging and log aggregation
  format: json

# Access log configuration
# SECURITY: Access logs record all HTTP requests for audit and debugging
accessLog:
  # Enable access logging with JSON format
  format: json
  # Buffer size (number of access logs to buffer before writing)
  # PERFORMANCE: Batches writes to reduce I/O overhead
  bufferingSize: 100
  # Filter access logs to reduce volume
  filters:
    # Log all status codes (comment out to log only errors)
    # statusCodes:
    #   - "400-599"
    # Minimum duration to log (filters out fast requests)
    minDuration: "10ms"
  # Fields to include in access logs
  fields:
    # Default field mode (keep, drop, redact)
    defaultMode: keep
    # Specific field overrides
    headers:
      defaultMode: drop
      # Keep specific headers for debugging
      names:
        User-Agent: keep
        X-Forwarded-For: keep
        X-User-Id: keep

# -----------------------------------------------------------------------------
# Tracing (OpenTelemetry)
# -----------------------------------------------------------------------------
# OBSERVABILITY: Distributed tracing for request flow visualization.
# Uses OpenTelemetry (OTLP) protocol to send traces to Jaeger.
#
# NOTE: The Jaeger tracing backend was removed in Traefik v3.
# Jaeger supports OTLP natively via ports 4317 (gRPC) and 4318 (HTTP).
# For more information, see the Traefik v3 migration guide:
# https://doc.traefik.io/traefik/v3.0/migration/v2-to-v3/#tracing
tracing:
  # OpenTelemetry backend for distributed tracing
  otlp:
    # OTLP HTTP endpoint (Jaeger supports OTLP on port 4318)
    http:
      endpoint: "http://jaeger:4318/v1/traces"

# -----------------------------------------------------------------------------
# Metrics (Prometheus)
# -----------------------------------------------------------------------------
# OBSERVABILITY: Prometheus metrics for monitoring and alerting.
# Exposes HTTP request metrics, response times, and error rates.
metrics:
  prometheus:
    # Add entrypoint labels to metrics
    addEntryPointsLabels: true
    # Add service labels to metrics
    addServicesLabels: true
    # Add router labels to metrics
    addRoutersLabels: true
    # Expose metrics on the traefik entrypoint (port 8080)
    entryPoint: traefik
    # Buckets for request duration histogram
    # MONITORING: Enables latency percentile calculations
    buckets:
      - 0.1
      - 0.3
      - 1.2
      - 5.0

# -----------------------------------------------------------------------------
# Certificate Resolvers (Let's Encrypt / ACME)
# -----------------------------------------------------------------------------
# SECURITY: Automatic TLS certificate management using ACME protocol.
# Supports Let's Encrypt for free, trusted certificates in production.
#
# PRODUCTION SETUP:
#   1. Uncomment the certificatesResolvers section below
#   2. Update email address for certificate notifications
#   3. Ensure port 80 is accessible for HTTP-01 challenge
#   4. Or use DNS-01 challenge for wildcard certificates
#
# SELF-SIGNED CERTIFICATES (Development):
#   For development, use self-signed certificates configured in dynamic config.
#   See: infrastructure/traefik/certs/README.md for generation instructions.
#
# certificatesResolvers:
#   letsencrypt:
#     acme:
#       # Email for certificate expiry notifications
#       email: admin@example.com
#       # Storage file for ACME account and certificates
#       storage: /etc/traefik/acme.json
#       # HTTP-01 challenge (requires port 80 access)
#       httpChallenge:
#         entryPoint: web
#       # Alternative: DNS-01 challenge for wildcards
#       # dnsChallenge:
#       #   provider: cloudflare
#       #   resolvers:
#       #     - "1.1.1.1:53"
#       #     - "8.8.8.8:53"
