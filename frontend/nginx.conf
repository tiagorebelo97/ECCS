# ============================================================================
# ECCS Frontend Nginx Configuration
# ============================================================================
# This configuration serves the React SPA and proxies API requests to Traefik.
#
# FEATURES:
#   - Static file serving with caching
#   - SPA routing (all routes serve index.html)
#   - API proxy to backend via Traefik
#   - Gzip compression for performance
#   - Security headers for protection
#
# PODMAN COMPATIBILITY:
#   - Uses port 3000 (unprivileged for rootless)
#   - Runs as nginx user (non-root)
#   - Dynamic DNS resolution for upstream services
# ============================================================================

# DNS resolver for dynamic upstream resolution
# Uses Docker/Podman internal DNS (127.0.0.11) with fallback options
# valid=30s: cache DNS results for 30 seconds
# ipv6=off: disable IPv6 resolution to avoid issues in some container networks
resolver 127.0.0.11 valid=30s ipv6=off;

server {
    # -------------------------------------------------------------------------
    # Server Configuration
    # -------------------------------------------------------------------------
    # Listen on port 3000 (unprivileged port for rootless containers)
    listen 3000;
    
    # Server name (for virtual hosting)
    server_name localhost;
    
    # Document root for static files
    root /usr/share/nginx/html;
    
    # Default index file
    index index.html;

    # -------------------------------------------------------------------------
    # SPA Routing
    # -------------------------------------------------------------------------
    # Serve React application
    # For any route not matching a file, serve index.html
    # This enables client-side routing (React Router)
    location / {
        try_files $uri $uri/ /index.html;
        
        # Cache control for static assets
        # HTML should not be cached to ensure fresh deployments
        location ~* \.html$ {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
        }
        
        # Cache static assets (JS, CSS, images) for 1 year
        # These have content hashes, so new versions get new URLs
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # -------------------------------------------------------------------------
    # API Proxy
    # -------------------------------------------------------------------------
    # Forward API requests to Traefik API gateway
    # This allows the frontend to make same-origin API calls
    location /api {
        # Use variable for dynamic DNS resolution at request time
        # This prevents nginx from failing at startup if traefik is not yet available
        set $upstream_traefik traefik:8800;
        
        # Proxy to Traefik (port 8800 for rootless Podman compatibility)
        proxy_pass http://$upstream_traefik;
        
        # HTTP version for WebSocket support
        proxy_http_version 1.1;
        
        # Headers for WebSocket upgrade
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        
        # Preserve original host header
        proxy_set_header Host $host;
        
        # Forward real client IP
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Bypass cache for API requests
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts for long-running requests
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # -------------------------------------------------------------------------
    # Health Check Endpoint
    # -------------------------------------------------------------------------
    # Simple health check for container orchestration
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # -------------------------------------------------------------------------
    # Compression
    # -------------------------------------------------------------------------
    # Enable gzip compression for text-based content
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 256;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/x-javascript
        application/xml
        application/xml+rss
        application/vnd.ms-fontobject
        application/x-font-ttf
        font/opentype
        image/svg+xml
        image/x-icon;

    # -------------------------------------------------------------------------
    # Security Headers
    # -------------------------------------------------------------------------
    # Add security headers to all responses
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Content Security Policy (adjust based on your needs)
    # add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self';" always;

    # -------------------------------------------------------------------------
    # Error Pages
    # -------------------------------------------------------------------------
    # Custom error pages (optional)
    error_page 404 /index.html;
    error_page 500 502 503 504 /index.html;

    # -------------------------------------------------------------------------
    # Logging
    # -------------------------------------------------------------------------
    # Access and error logs
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;
}
